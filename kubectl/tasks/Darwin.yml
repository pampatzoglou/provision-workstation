---
- name: Install kubectl
  community.general.homebrew:
    name: kubectl
    state: present
    update_homebrew: true
  tags:
    - kubernetes
    - kubectl

- name: Install, configure kubectl krew
  block:
    - name: Check if krew is installed
      ansible.builtin.stat:
        path: '/Users/{{ user }}/.local/share/krew'
      register: krew_installed

    - name: Create temporary build directory
      ansible.builtin.tempfile:
        state: directory
        suffix: temp_dir
      register: temp_dir
      when: not krew_installed.stat.exists

    - name: Download krew (sha256)
      ansible.builtin.get_url:
        url: 'https://github.com/kubernetes-sigs/krew/releases/download/v{{ krew.version }}/krew-darwin_amd64.tar.gz'
        dest: '{{ temp_dir.path }}'
        checksum: 'sha256:{{ krew.sha.amd64.darwin }}'
        mode: '0744'
      when: not krew_installed.stat.exists

    - name: Unarchive krew
      ansible.builtin.unarchive:
        src: '{{ temp_dir.path }}/krew-darwin_amd64.tar.gz'
        dest: '{{ temp_dir.path }}'
        remote_src: true
      when: not krew_installed.stat.exists

    - name: Install krew
      ansible.builtin.copy:
        src: '{{ temp_dir.path }}/krew-darwin_amd64'
        dest: '/Users/{{ user }}/.local/share/krew'
        owner: '{{ user }}'
        mode: 'a+x'
        remote_src: true
      when: not krew_installed.stat.exists

    - name: Remove the temporary dir
      ansible.builtin.file:
        path: '{{ temp_dir.path }}'
        state: absent
      when: temp_dir.path is defined
  become: true
  tags:
    - kubernetes
    - kubectl
    - krew
